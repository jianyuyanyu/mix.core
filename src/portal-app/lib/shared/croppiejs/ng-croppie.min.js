angular.module('angularCroppie', []).
  component('croppie', {
    bindings: {
      src: '<',
      ngModel: '=',
      viewportW: '=',
      viewportH: '=',
      outputW: '=',
      outputH: '=',
      onUpdate: '&',
      options: '<'
    },
    controller: ['$scope', '$element', function ($scope, $element) {
      var ctrl = this;

      this.$onInit = function () {
        var options = angular.extend({
          viewport: {
            width: ctrl.viewportW || 200,
            height: ctrl.viewportH || 200
          }
        }, ctrl.options);

        options.update = function () {
          c.result({
            type: 'canvas',
            size: { width: ctrl.outputW || ctrl.viewportW, height: ctrl.outputH || ctrl.viewportH }
          }).then(function (img) {
            $scope.$apply(function () {
              ctrl.ngModel = img;
            });
            if (ctrl.onUpdate) {
              ctrl.onUpdate();
            }
          });
        };

        var c = new Croppie($element[0], options);

        ctrl.$onChanges = function (changesObj) {
          var src = changesObj.src && changesObj.src.currentValue;
          if (src) {
            // bind an image to croppie
            c.bind({
              url: src
            });
          }
        };
      };
    }]
  });