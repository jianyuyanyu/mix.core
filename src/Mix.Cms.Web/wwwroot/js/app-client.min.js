'use strict';

var app = angular.module('MixClient', ['ngRoute', 'LocalStorageModule', 'components', 'ngFileUpload', 'angularCroppie', 
    'cart', 'ngSanitize']);
var serviceBase = '';
var modules = angular.module('components', []);
var cart = angular.module('cart', []);

// This is the "Offline page" service worker
// Add this below content to your HTML page, or add the js file to your page at the very top to register service worker
// Check compatibility for the browser we're running this in
// if ("serviceWorker" in navigator) {
//     if (navigator.serviceWorker.controller) {
//         console.log("[PWA Builder] active service worker found, no need to register");
//     } else {
//         // Register the service worker
//         navigator.serviceWorker
//             .register("service-worker.js", {
//                 scope: "./"
//             })
//             .then(function (reg) {
//                 console.log("[PWA Builder] Service worker has been registered for scope: " + reg.scope);
//             });
//     }
// }

(function (angular) {
    'use strict';
    app.controller('AppClientController',
        ['$rootScope', '$scope', 'GlobalSettingsService', 'CommonService', 'AuthService', 'localStorageService', 'TranslatorService', 'SharedModuleDataService',
            function ($rootScope, $scope, globalSettingsService, commonService, authService,
                localStorageService, translatorService, moduleDataService) {
                $scope.lang = '';
                $scope.isInit = false;
                $scope.isLoaded = false;
                $scope.mediaFile = {
                    file: null,
                    fullPath: '',
                    folder: 'module-data',
                    title: '',
                    description: ''
                };
                $scope.cartData = {
                    items: [],
                    totalItems: 0,
                    total: 0,
                };
                $rootScope.globalSettingsService = globalSettingsService;
                $scope.changeLang = $rootScope.changeLang;
                $scope.init = function (lang) {
                    if (!$rootScope.isBusy) {
                        $rootScope.isBusy = true;
                        // globalSettingsService.fillGlobalSettings().then(function (response) {
                        $scope.cartData = localStorageService.get('shoppingCart');
                        if (!$scope.cartData) {
                            $scope.cartData = {
                                items: [],
                                totalItems: 0,
                                total: 0,
                            };
                        }
                        commonService.fillAllSettings(lang).then(function (response) {
                            if ($rootScope.globalSettings) {
                                authService.fillAuthData().then(function (response) {
                                    $rootScope.authentication = authService.authentication;
                                    $scope.isInit = true;
                                    $rootScope.isInit = true;
                                    $rootScope.isBusy = false;
                                    $scope.$apply();
                                });

                                // });                                
                            } else {
                                $scope.isInit = true;
                                $rootScope.isInit = true;
                                $rootScope.isBusy = false;
                            }
                        });

                        // });

                    }

                    $(document).on('click', 'a', function(e){                        
                        var href = $(this).attr('href');
                        var target = $(this).attr('target');
                        if(href && href.indexOf('#') !== 0 && target!='_blank'){
                            e.preventDefault();                            
                            $scope.$apply($scope.isBusy = true);
                            setTimeout(() => {
                                // window.location.href = href;
                                window.open(href, target || '_top');
                            }, (200));
                        }
                    });
                };

                $scope.translate = $rootScope.translate;
                $scope.previewData = function (moduleId, id) {
                    var obj = {
                        moduleId: moduleId,
                        id: id
                    };
                    $rootScope.preview('module-data', obj, null, 'modal-lg');
                };

                $scope.initModuleForm = async function (name, successCallback, failCallback) {
                    var resp = null;
                    $scope.successCallback = successCallback;
                    $scope.failCallback = failCallback;
                    setTimeout(async () => {
                        $scope.name = name;
                        if ($scope.id) {
                            resp = await moduleDataService.getModuleData($scope.id, $scope.dataId, 'portal');
                        }
                        else {
                            resp = await moduleDataService.initModuleForm($scope.name);
                        }

                        if (resp && resp.isSucceed) {
                            $scope.activedModuleData = resp.data;
                            $rootScope.isBusy = false;
                            $scope.$apply();
                        }
                        else {
                            if (resp) {
                                if ($scope.errorCallback) {
                                    $rootScope.executeFunctionByName($scope.errorCallback, [resp], window);
                                }
                                else {
                                    $rootScope.showErrors(resp.errors);
                                }
                            }
                            $rootScope.isBusy = false;
                            $scope.$apply();
                        }
                    }, 500);
                };
               
                $scope.saveModuleData = async function () {

                    var resp = await moduleDataService.saveModuleData($scope.activedModuleData);
                    if (resp && resp.isSucceed) {
                        $scope.activedModuleData = resp.data;
                        if ($scope.successCallback) {
                            $rootScope.executeFunctionByName($scope.successCallback, [resp], window);
                        }
                        else {
                            var msg = $rootScope.settings.data['employee_success_msg'] || 'Thank you for submitting! Your lovely photo is well received ðŸ˜Š';
                            $rootScope.showConfirm($scope, '', [], null, '', msg);
                        }

                        $rootScope.isBusy = false;
                        $scope.initModuleForm($scope.name);
                        $rootScope.isBusy = false;
                        $scope.$apply();
                    }
                    else {
                        if (resp) {
                            if ($scope.failCallback) {
                                $rootScope.executeFunctionByName($scope.failCallback, [resp], window);
                            }
                            else {
                                $rootScope.showErrors(resp.errors);
                            }
                        }
                        $rootScope.isBusy = false;
                        $scope.$apply();
                    }
                };
                $scope.shareFB = function (url) {
                    FB.ui({
                        method: 'share',
                        href: url,
                    }, function (response) { });
                };
                $scope.shareTwitter = function (url, content) {
                    var text = encodeURIComponent(content);
                    var shareUrl = 'https://twitter.com/intent/tweet?url=' + url + '&text=' + text;
                    var win = window.open(shareUrl, 'ShareOnTwitter', getWindowOptions());
                    win.opener = null; // 2
                };
                $scope.saveShoppingCart = function () {
                    localStorageService.set('shoppingCart', $scope.cartData);
                };

                var getWindowOptions = function () {
                    var width = 500;
                    var height = 350;
                    var left = (window.innerWidth / 2) - (width / 2);
                    var top = (window.innerHeight / 2) - (height / 2);

                    return [
                        'resizable,scrollbars,status',
                        'height=' + height,
                        'width=' + width,
                        'left=' + left,
                        'top=' + top,
                    ].join();
                };
                window.load = function(){
                    $scope.$apply($scope.isLoaded = true);
                };
            }]);


})(window.angular);
modules.component('addToCartButton', {
    templateUrl: '/app/app-client/components/add-to-cart-button/view.html',
    controller: ['$rootScope', 'localStorageService',
        function ($rootScope, localStorageService) {
            var ctrl = this;
            ctrl.addToCart = function () {
                var current = $rootScope.findObjectByKey(ctrl.cartData.items, 'propertyId', ctrl.propertyId);
                if (current) {
                    current.quantity += parseInt(ctrl.quantity);
                }
                else {
                    var item = {
                        propertyId: ctrl.propertyId,
                        title: ctrl.title,
                        imageUrl: ctrl.imageUrl,
                        price: ctrl.price,
                        quantity: parseInt(ctrl.quantity) || 1
                    };
                    ctrl.cartData.items.push(item);
                    ctrl.cartData.totalItems += 1;
                }
                ctrl.cartData.total+= parseInt(ctrl.price);
                localStorageService.set('shoppingCart', ctrl.cartData);
            }
        }
    ],
    bindings: {
        cartData: '=',
        propertyId: '=',
        title: '=',
        imageUrl: '=',
        price: '=',
        quantity: '=',
    }
});
modules.component('attributeSetForm', {
    templateUrl: '/app/app-client/components/attribute-set-form/view.html',
    bindings: {
        attrSetId: '=',
        attrSetName: '=',
        attrDataId: '=?',
        attrData: '=?',
        parentType: '=?', // attribute set = 1 | post = 2 | page = 3 | module = 4
        parentId: '=?',
        defaultId: '=',
        saveData: '&?'
    },
    controller: ['$rootScope', '$scope', 'AttributeSetDataService',
        function ($rootScope, $scope, service) {
            var ctrl = this;
            ctrl.isBusy = false;
            ctrl.attributes = [];
            ctrl.defaultData = null;
            ctrl.selectedProp = null;
            ctrl.settings = $rootScope.globalSettings;
            ctrl.$onInit = async function () {
                ctrl.loadData();
            };
            ctrl.loadData = async function () {

                /*
                    If input is data id => load ctrl.attrData from service and handle it independently
                    Else modify input ctrl.attrData
                */
                $rootScope.isBusy = true;
                ctrl.defaultData = await service.getSingle('portal', [ctrl.defaultId, ctrl.attrSetId, ctrl.attrSetName]);
                if (ctrl.attrDataId) {
                    ctrl.attrData = await service.getSingle('portal', [ctrl.attrDataId, ctrl.attrSetId, ctrl.attrSetName]);
                    if (ctrl.attrData) {
                        ctrl.defaultData.attributeSetId = ctrl.attrData.attributeSetId;
                        ctrl.defaultData.attributeSetName = ctrl.attrData.attributeSetName;
                        $rootScope.isBusy = false;
                        $scope.$apply();
                    } else {
                        if (ctrl.attrData) {
                            $rootScope.showErrors('Failed');
                        }
                        $rootScope.isBusy = false;
                        $scope.$apply();
                    }

                }
                else {
                    if (!ctrl.attrData) {
                        ctrl.attrData = angular.copy(ctrl.defaultData);
                    }
                    $rootScope.isBusy = false;
                    $scope.$apply();
                }
                console.log(ctrl.attrData);
            };
            ctrl.reload = async function () {
                ctrl.attrData = angular.copy(ctrl.defaultData);
            };
            ctrl.submit = async function () {
                angular.forEach(ctrl.attrData.values, function (e) {
                    //Encrypt field before send
                    if (e.field && e.field.isEncrypt) {
                        var encryptData = $rootScope.encrypt(e.stringValue);
                        e.encryptKey = encryptData.key;
                        e.encryptValue = encryptData.data;
                        e.stringValue = null;
                    }
                });

                ctrl.isBusy = true;
                var saveResult = await service.save('portal', ctrl.attrData);
                if (saveResult.isSucceed) {

                    ctrl.isBusy = false;
                } else {
                    ctrl.isBusy = false;
                    if (saveResult) {
                        $rootScope.showErrors(saveResult.errors);
                    }
                    $scope.$apply();
                }
            };

            ctrl.filterData = function (attributeName) {
                if (ctrl.attrData) {
                    var attr = $rootScope.findObjectByKey(ctrl.attrData.data, 'attributeFieldName', attributeName);
                    if (!attr) {
                        attr = angular.copy($rootScope.findObjectByKey(ctrl.defaultData.data, 'attributeFieldName', attributeName));
                        ctrl.attrData.data.push(attr);
                    }
                    return attr;
                }
            };
        }]
});
modules.component('booking', {
    templateUrl: '/app/app-client/components/booking/index.html',
    controller: [
        '$rootScope', 'CommonService', 
        function ($rootScope, commonService) {
            var ctrl = this;
            ctrl.submitted = false;
            ctrl.isShow = false;
            ctrl.order = {
                name:'',
                propertyId:'',
                price:'',
                quantity: 1
            };
            ctrl.edm = 'Url: <a href="[url]">View Tour</a> <br/>Name: [name] <br/>'
                        + 'Phone: [phone]<br/>'
                        + 'Email: [email]<br/>'
                        + 'Quantity: [quantity]<br/>'
                        + 'Message: [message] <br/>'
                        + 'property: [property] <br/>Price: [price] <br/>';
            ctrl.init = function () {
                if (!$rootScope.isInit) {
                    setTimeout(function () { ctrl.init(); }, 500);
                } else {
                    ctrl.order.propertyId = ctrl.propertyId;
                    ctrl.order.price = ctrl.price;
                    ctrl.order.quantity = ctrl.quantity;
                }
            }
            ctrl.book = function(){
                ctrl.edm = ctrl.edm.replace(/\[url\]/g,window.top.location.href);
                ctrl.edm = ctrl.edm.replace(/\[name\]/g,ctrl.order.name);
                ctrl.edm = ctrl.edm.replace(/\[phone\]/g,ctrl.order.phone);
                ctrl.edm = ctrl.edm.replace(/\[email\]/g,ctrl.order.email);
                ctrl.edm = ctrl.edm.replace(/\[message\]/g,ctrl.order.message);
                ctrl.edm = ctrl.edm.replace(/\[property\]/g,ctrl.order.propertyId);
                ctrl.edm = ctrl.edm.replace(/\[price\]/g,ctrl.order.price);
                ctrl.edm = ctrl.edm.replace(/\[quantity\]/g,ctrl.order.quantity);
                
                commonService.sendMail('Booking - ' + ctrl.propertyName, ctrl.edm);
                ctrl.submitted = true;
            }
        }
    ],
    bindings: {
        propertyId: '=',
        propertyName: '=',
        price: '=',
        quantity: '=',
    }
});

modules.component('attributeValueEditor', {
    templateUrl: '/app/app-client/components/attribute-value-editor/view.html',
    bindings: {
        attributeValue: '=?',
        parentType: '=?',
        parentId: '=?',
        isShowTitle: '=?',
    },
    controller: ['$rootScope', '$scope', 'ngAppSettings', '$location', 'RelatedAttributeSetDataService', 'AttributeSetDataService', 
        function ($rootScope, $scope, ngAppSettings,$location, navService,dataService) {
        var ctrl = this;
        ctrl.goToPath = $rootScope.goToPath;
        ctrl.icons = ngAppSettings.icons;
        ctrl.refData = null;
        ctrl.defaultDataModel = null;
        ctrl.refDataModel = {
            id: null,
            data: null
        };
        ctrl.refRequest = angular.copy(ngAppSettings.request);
        ctrl.refRequest.pageSize = 100;
        ctrl.dataTypes = $rootScope.globalSettings.dataTypes;
        ctrl.previousId = null;
        ctrl.$doCheck = function () {
            if (ctrl.attributeValue && ctrl.previousId !== ctrl.attributeValue.id) {
                ctrl.previousId = ctrl.attributeValue.id;
                ctrl.initData();
            }
        }.bind(ctrl);
        ctrl.$onInit = function () {
            ctrl.initData();
        };
        ctrl.initData = async function(){
            setTimeout(() => {                
                if(!ctrl.attributeValue.id){
                    ctrl.initDefaultValue();
                }
                switch (ctrl.attributeValue.dataType) {
                    case 1:
                    case 2:
                    case 3:                        
                        if (ctrl.attributeValue.dateTimeValue) {
                            ctrl.attributeValue.dateObj = new Date(ctrl.attributeValue.dateTimeValue);
                            $scope.$apply();
                        }
                        break;
                    case 23: // reference
                        if(ctrl.attributeValue.field.referenceId && ctrl.parentId){
                            ctrl.attributeValue.integerValue = ctrl.attributeValue.field.referenceId;
                            navService.getSingle('portal', [ctrl.parentId, ctrl.parentType, 'default', ctrl.attributeValue.field.referenceId]).then(resp=>{
                                ctrl.defaultDataModel = resp;
                                ctrl.defaultDataModel.attributeSetId = ctrl.attributeValue.field.referenceId;
                                ctrl.refDataModel = angular.copy(ctrl.defaultDataModel);
                            });
                            ctrl.loadRefData();
                        }
                        break;
                    default:
                        
                        if (ctrl.attributeValue.field && ctrl.attributeValue.field.isEncrypt && ctrl.attributeValue.encryptValue) {
                            var encryptedData = {
                                key: ctrl.attributeValue.encryptKey,
                                data: ctrl.attributeValue.encryptValue
                            };
                            ctrl.attributeValue.stringValue = $rootScope.decrypt(encryptedData);
                        }
                        if (ctrl.attributeValue.field && !ctrl.attributeValue.stringValue) {
                            ctrl.attributeValue.stringValue = ctrl.attributeValue.field.defaultValue;
                            $scope.$apply();
                        }
                        break;
                }
            }, 200);
        };
        ctrl.initDefaultValue = async function () {
            switch (ctrl.attributeValue.dataType) {
                case 1:
                case 2:
                case 3:
                    if (ctrl.attributeValue.field.defaultValue) {
                        ctrl.attributeValue.dateObj = new Date(ctrl.attributeValue.field.defaultValue);
                        ctrl.attributeValue.stringValue = ctrl.attributeValue.field.defaultValue;
                    }
                    break;
                case 6:
                    if (ctrl.attributeValue.field.defaultValue) {
                        ctrl.attributeValue.doubleValue = parseFloat(ctrl.attributeValue.field.defaultValue);
                        ctrl.attributeValue.stringValue = ctrl.attributeValue.field.defaultValue;
                    }
                    break;
                case 18:
                    if (ctrl.attributeValue.field.defaultValue) {
                        ctrl.attributeValue.booleanValue = ctrl.attributeValue.field.defaultValue =='true';
                        ctrl.attributeValue.stringValue = ctrl.attributeValue.field.defaultValue;
                    }
                    break;

                default:
                    if (ctrl.attributeValue.field.defaultValue) {
                        ctrl.attributeValue.stringValue = ctrl.attributeValue.field.defaultValue;
                    }
                    break;
            }
        };
        ctrl.updateStringValue = async function (dataType) {
            switch (dataType) {
                case 1:
                case 2:
                case 3:
                    if (ctrl.attributeValue.dateObj) {
                        ctrl.attributeValue.dateTimeValue = ctrl.attributeValue.dateObj.toISOString();
                        ctrl.attributeValue.stringValue = ctrl.attributeValue.dateTimeValue;
                    }
                    break;
                case 6:
                    if (ctrl.attributeValue.doubleValue) {
                        ctrl.attributeValue.stringValue = ctrl.attributeValue.doubleValue.toString();
                    }
                    break;
                case 18:
                    if (ctrl.attributeValue.booleanValue != null) {
                        ctrl.attributeValue.stringValue = ctrl.attributeValue.booleanValue.toString();
                    }
                    break;

                default:
                    break;
            }
        };
        ctrl.loadRefData = function(){
            navService.getList('portal', ctrl.refRequest, 
                ctrl.attributeValue.field.referenceId, ctrl.parentType, ctrl.parentId)
                .then(resp=>{
                if (resp) 
                {
                    ctrl.refData = resp;
                    $rootScope.isBusy = false;
                    $scope.$apply();
                } else {
                    if (resp) {
                        $rootScope.showErrors('Failed');
                    }
                    ctrl.refData = [];
                    $rootScope.isBusy = false;
                    $scope.$apply();
                }
            });
        }
        ctrl.updateRefData = function(nav){
            ctrl.goToPath('/portal/attribute-set-data/details?dataId=' + nav.data.id + '&attributeSetId=' + nav.data.attributeSetId)
            // ctrl.refDataModel = nav;
            // var e = $(".pane-form-" + ctrl.attributeValue.field.referenceId)[0];
            // angular.element(e).triggerHandler('click');
            // $location.url('/portal/attribute-set-data/details?dataId='+ item.id +'&attributeSetId=' + item.attributeSetId+'&parentType=' + item.parentType+'&parentId=' + item.parentId);
        };
        ctrl.saveRefData = function(data){            
            $rootScope.isBusy = true;
            ctrl.refDataModel.data = data;
            dataService.save('portal', data).then(resp=>{
                if(resp.isSucceed){
                    ctrl.refDataModel.id = resp.data.id;
                    ctrl.refDataModel.data = resp.data;
                    navService.save('portal', ctrl.refDataModel).then(resp=>{
                        if(resp.isSucceed){
                            var tmp = $rootScope.findObjectByKey(ctrl.refData, ['parentId', 'parentType', 'id'], 
                                [resp.data.parentId, resp.data.parentType, resp.data.id]);
                            if(!tmp){
                                ctrl.refData.push(resp.data);
                            }
                            ctrl.refDataModel = angular.copy(ctrl.defaultDataModel);
                            var e = $(".pane-data-" + ctrl.attributeValue.field.referenceId)[0];                                
                            angular.element(e).triggerHandler('click');
                            $rootScope.isBusy = false;
                            $scope.$apply();
                        }else{
                            $rootScope.showMessage('failed');    
                            $rootScope.isBusy = false;
                            $scope.$apply();
                        }
                    })
                    
                }
                else{
                    $rootScope.showMessage('failed');    
                    $rootScope.isBusy = false;
                    $scope.$apply();
                }
            })
        }
        ctrl.removeRefData = async function(nav){
            $rootScope.showConfirm(ctrl, 'removeRefDataConfirmed', [nav], null, 'Remove', 'Deleted data will not able to recover, are you sure you want to delete this item?');
        };
        ctrl.removeRefDataConfirmed = async function(nav){
            $rootScope.isBusy = true;
            var result = await navService.delete([nav.parentId, nav.parentType, nav.id]);
            if (result.isSucceed) {
                $rootScope.removeObjectByKey(ctrl.refData, 'id', nav.id);
                $rootScope.isBusy = false;
                $scope.$apply();
            }
            else {
                $rootScope.showMessage('failed');
                $rootScope.isBusy = false;
                $scope.$apply();
            }
        };
    }]
});
modules.component('employeeForm', {
    templateUrl: '/app/app-client/components/employee-form/view.html',
    bindings: {
        attrSetId: '=',
        attrSetName: '=',
        attrDataId: '=?',
        attrData: '=?',
        parentType: '=?', // attribute set = 1 | post = 2 | page = 3 | module = 4
        parentId: '=?',
        defaultId: '=',
        saveData: '&?'
    },
    controller: ['$rootScope', '$scope', 'BaseService', 'AttributeSetDataService',
        function ($rootScope, $scope, baseService, service) {
            var ctrl = this;
            ctrl.isBusy = false;
            ctrl.attributes = [];
            ctrl.defaultData = null;
            ctrl.selectedProp = null;
            ctrl.settings = $rootScope.globalSettings;
            ctrl.mediaFile = {
                file: null,
                fullPath: '',
                folder: 'module-data',
                title: '',
                description: ''
            };
            ctrl.$onInit = async function () {
                ctrl.loadData();
            };
            ctrl.loadData = async function () {

                /*
                    If input is data id => load ctrl.attrData from service and handle it independently
                    Else modify input ctrl.attrData
                */
                $rootScope.isBusy = true;
                ctrl.defaultData = await service.getSingle('portal', [ctrl.defaultId, ctrl.attrSetId, ctrl.attrSetName]);
                if (ctrl.attrDataId) {
                    ctrl.attrData = await service.getSingle('portal', [ctrl.attrDataId, ctrl.attrSetId, ctrl.attrSetName]);
                    if (ctrl.attrData) {
                        ctrl.defaultData.attributeSetId = ctrl.attrData.attributeSetId;
                        ctrl.defaultData.attributeSetName = ctrl.attrData.attributeSetName;
                        $rootScope.isBusy = false;
                        $scope.$apply();
                    } else {
                        if (ctrl.attrData) {
                            $rootScope.showErrors('Failed');
                        }
                        $rootScope.isBusy = false;
                        $scope.$apply();
                    }

                }
                else {
                    if (!ctrl.attrData) {
                        ctrl.attrData = angular.copy(ctrl.defaultData);
                    }
                    $rootScope.isBusy = false;
                    $scope.$apply();
                }
            };
            ctrl.reload = async function () {
                ctrl.attrData = angular.copy(ctrl.defaultData);
            };
            ctrl.submit = async function () {
                angular.forEach(ctrl.attrData.values, function (e) {
                    //Encrypt field before send
                    if (e.field && e.field.isEncrypt) {
                        var encryptData = $rootScope.encrypt(e.stringValue);
                        e.encryptKey = encryptData.key;
                        e.encryptValue = encryptData.data;
                        e.stringValue = null;
                    }
                });

                ctrl.isBusy = true;
                var saveResult = await service.save('portal', ctrl.attrData);
                if (saveResult.isSucceed) {
                    ctrl.isBusy = false;
                    $rootScope.isBusy = false;
                    $scope.$apply();
                } else {
                    ctrl.isBusy = false;
                    $rootScope.isBusy = false;
                    if (saveResult) {
                        $rootScope.showErrors(saveResult.errors);
                    }
                    $scope.$apply();
                }
            };

            ctrl.filterData = function (attributeName) {
                if (ctrl.attrData) {
                    var attr = $rootScope.findObjectByKey(ctrl.attrData.values, 'attributeFieldName', attributeName);
                    if (!attr) {
                        attr = angular.copy($rootScope.findObjectByKey(ctrl.defaultData.values, 'attributeFieldName', attributeName));
                        ctrl.attrData.data.push(attr);
                    }
                    return attr;
                }
            };

            ctrl.saveEmployee = function () {
                var msg = $rootScope.settings.data['employee_confirm_msg'] || 'Are you sure you want to submit this form? Please be noted that after submission, all information cannot be changed or adjusted.';
                $rootScope.showConfirm(ctrl, 'saveEmployeeConfirmed', [], null, '', msg);
            };
            ctrl.saveEmployeeConfirmed = async function () {
                if (ctrl.validateEmployee(ctrl.attrData)) {
                    var mediaService = angular.copy(baseService);
                    mediaService.init('media');
                    $rootScope.isBusy = true;
                    var getMedia = await mediaService.getSingle(['portal']);
                    if (getMedia.isSucceed) {
                        
                        var media = getMedia.data;
                        media.title = '';
                        media.description = '';
                        media.mediaFile = ctrl.mediaFile;

                        var url = mediaService.prefixUrl + '/save';
                        var fd = new FormData();
                        // var file = media.mediaFile.file;
                        media.mediaFile.file = null;
                        fd.append('model', angular.toJson(media));
                        fd.append('file', null);                        
                        
                        var resp = await mediaService.ajaxSubmitForm(fd, url);
                        if (resp && resp.isSucceed) {
                            var avatar = ctrl.filterData('avatar');
                            if (avatar) {
                                avatar.stringValue = resp.data.fullPath;
                            }

                            return ctrl.submit();
                        }
                        else {
                            if (resp) { $rootScope.showErrors(resp.errors); }
                            $rootScope.isBusy = false;
                            $scope.$apply();
                        }
                    }

                }
            };
            ctrl.validateEmployee = function (data) {
                if (!ctrl.mediaFile.fileName) {
                    $rootScope.showErrors([$rootScope.translate('avatar_required')]);
                    return false;
                } else {
                    return true;
                }
            };
        }]
});

modules.component('fbCustomerChat', {
    templateUrl: '/app/app-client/components/fb-customer-chat/view.html',
    controller: ['$location', function ($location) {
        var ctrl = this;
        this.$onInit = function(){
            setTimeout(() => {
                FB.XFBML.parse();
            }, 200);
        }    
    }],
    bindings: {
        fbPageId:'=',
        themeColor:'=',
        inGreeting:'=',
        outGreeting:'='
    }
});

modules.component('fbLike', {
    templateUrl: '/app/app-client/components/fb-like/fb-like.html',
    controller: ['$location', function ($location) {
        var ctrl = this;
        ctrl.href = ctrl.href || window.top.location.href;        
        ctrl.layout = ctrl.layout || 'standard';        
        ctrl.size = ctrl.size || 'small';        
        ctrl.showFaces = ctrl.showFaces || true;    
        this.$onInit = function(){
            setTimeout(() => {
                FB.XFBML.parse();
            }, 200);
        }    
    }],
    bindings: {
        href:'=',
        layout:'=',
        size:'=',
        showFaces:'='
    }
});

modules.component('fbSend', {
    templateUrl: '/app/app-client/components/fb-send/fb-send.html',
    controller: ['$location', function ($location) {
        var ctrl = this;
        ctrl.href = ctrl.href || window.top.location.href;
        ctrl.send = function () {
            var link = ctrl.href || window.top.location.href;
            FB.ui({
                method: 'send',
                link: link,
            }, function (response) { });
        };
    }],
    bindings: {
        href:'=',
        appId:'='
    }
});

modules.component('fbShare', {
    templateUrl: '/app/app-client/components/fb-share/fb-share.html',
    controller: ['$location', function ($location) {
        var ctrl = this;
        ctrl.href = ctrl.href || window.top.location.href;
        ctrl.share = function () {
            var href = window.top.location.href;
            FB.ui({
                method: 'share',
                href: href,
            }, function (response) { });
        };
    }],
    bindings: {
        href:'='
    }
});
modules.component('googlePay', {
    templateUrl: '/app/app-client/components/google-pay/view.html',
    controller: [
        '$rootScope', 'CommonService',
        function ($rootScope, commonService) {
            var ctrl = this;
            ctrl.baseRequest = {
                apiVersion: 2,
                apiVersionMinor: 0
            };
            ctrl.tokenizationSpecification = {
                type: 'PAYMENT_GATEWAY',
                parameters: {
                    'gateway': 'example',
                    'gatewayMerchantId': 'exampleGatewayMerchantId'
                }
            };
            ctrl.allowedCardNetworks = ["AMEX", "DISCOVER", "JCB", "MASTERCARD", "VISA"];
            ctrl.allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];
            ctrl.baseCardPaymentMethod = {
                type: 'CARD',
                parameters: {
                    allowedAuthMethods: ctrl.allowedCardAuthMethods,
                    allowedCardNetworks: ctrl.allowedCardNetworks
                }
            };
            ctrl.cardPaymentMethod = Object.assign(
                { tokenizationSpecification: ctrl.tokenizationSpecification },
                ctrl.baseCardPaymentMethod
            );
            ctrl.paymentsClient = null;
            ctrl.paymentDataRequest = null;
            ctrl.getGoogleIsReadyToPayRequest = function () {
                return Object.assign(
                    {},
                    ctrl.baseRequest,
                    {
                        allowedPaymentMethods: [ctrl.baseCardPaymentMethod]
                    }
                );
            };
            ctrl.getGooglePaymentDataRequest = function() {
                ctrl.paymentDataRequest = Object.assign({}, ctrl.baseRequest);
                ctrl.paymentDataRequest.allowedPaymentMethods = [ctrl.cardPaymentMethod];
                ctrl.paymentDataRequest.transactionInfo = ctrl.getGoogleTransactionInfo();
                ctrl.paymentDataRequest.merchantInfo = {
                  // @todo a merchant ID is available for a production environment after approval by Google
                  // See {@link https://developers.google.com/pay/api/web/guides/test-and-deploy/integration-checklist|Integration checklist}
                  merchantId: '01234567890123456789',
                  merchantName: 'Example Merchant'
                };
                return ctrl.paymentDataRequest;
              };
              ctrl.getGooglePaymentsClient = function() {
                if ( ctrl.paymentsClient === null ) {
                    ctrl.paymentsClient = new google.payments.api.PaymentsClient({environment: 'TEST'});
                }
                return ctrl.paymentsClient;
              }
              ctrl.onGooglePayLoaded = function() {
                ctrl.paymentsClient = ctrl.getGooglePaymentsClient();
                ctrl.paymentsClient.isReadyToPay(ctrl.getGoogleIsReadyToPayRequest())
                    .then(function(response) {
                      if (response.result) {
                        ctrl.addGooglePayButton();
                        // @todo prefetch payment data to improve performance after confirming site functionality
                        // prefetchGooglePaymentData();
                      }
                    })
                    .catch(function(err) {
                      // show error in developer console for debugging
                      console.error(err);
                    });
              };
              ctrl.addGooglePayButton = function() {
                ctrl.paymentsClient = ctrl.getGooglePaymentsClient();
                const button =
                    ctrl.paymentsClient.createButton({onClick: ctrl.onGooglePaymentButtonClicked});
                document.getElementById('container').appendChild(button);
              };
              ctrl.getGoogleTransactionInfo = function() {
                return {
                  currencyCode: ctrl.currencyCode || 'USD',
                  totalPriceStatus: ctrl.totalPriceStatus || 'FINAL',
                  // set to cart total
                  totalPrice: ctrl.totalPrice || '0.00'
                };
              };
              ctrl.prefetchGooglePaymentData = function() {
                ctrl.paymentDataRequest = ctrl.getGooglePaymentDataRequest();
                // transactionInfo must be set but does not affect cache
                ctrl.paymentDataRequest.transactionInfo = {
                  totalPriceStatus: 'NOT_CURRENTLY_KNOWN',
                  currencyCode: 'USD'
                };
                ctrl.paymentsClient = ctrl.getGooglePaymentsClient();
                ctrl.paymentsClient.prefetchPaymentData(ctrl.paymentDataRequest);
              };
              ctrl.onGooglePaymentButtonClicked = function() {
                ctrl.paymentDataRequest = ctrl.getGooglePaymentDataRequest();
                ctrl.paymentDataRequest.transactionInfo = ctrl.getGoogleTransactionInfo();
              
                ctrl.paymentsClient = ctrl.getGooglePaymentsClient();
                ctrl.paymentsClient.loadPaymentData(ctrl.paymentDataRequest)
                    .then(function(paymentData) {
                      // handle the response
                      ctrl.processPayment(paymentData);
                    })
                    .catch(function(err) {
                      // show error in developer console for debugging
                      console.error(err);
                    });
              };
              ctrl.processPayment = function(paymentData) {
                // show returned data in developer console for debugging
                  // console.log(paymentData);
                // @todo pass payment token to your gateway to process payment
                paymentToken = paymentData.paymentMethodData.tokenizationData.token;
              };
              ctrl.init = function(){
                  setTimeout(() => {
                    ctrl.onGooglePayLoaded();
                  }, 1000);
              }
        }
    ],
    bindings: {
        totalPriceStatus: '=',
        currencyCode: '=',
        totalPrice: '='
    }
});
modules.component('mixMessagesHubClient', {
    templateUrl: '/app/app-client/components/mix-messages-hub-client/view.html',
    bindings: {
        attrSetName: '=',
        isSave: '=?'
    },
    controller: ['$rootScope', '$scope', 'AttributeFieldClientRestService', 'AttributeSetDataRestService',
        function ($rootScope, $scope, fieldService, service) {
            var ctrl = this;
            BaseHub.call(this, ctrl);
            ctrl.settings = $rootScope.globalSettings;
            ctrl.user = {
                loggedIn: false,
                connection: {}
            };
            ctrl.attrData = null;
            ctrl.isHide = true;
            ctrl.hideContact = true;
            ctrl.fields = [];
            ctrl.members = [];
            ctrl.errors =[];
            ctrl.messages = {
                items: []
            };
            ctrl.message = { connection: {}, content: '' };
            ctrl.request = {
                uid: '',
                specificulture: '',
                action: '',
                objectType: null,
                data: {},
                room: '',
                isMyself: true,
                isSave: false
            };
            ctrl.init = function () {
                ctrl.attrSetId = ctrl.attrSetId || 0;
                ctrl.request.specificulture = service.lang;
                ctrl.request.room = ctrl.attrSetName;
                ctrl.request.isSave = ctrl.isSave || false;
                ctrl.startConnection('serviceHub', ctrl.checkLoginStatus);
            };
            ctrl.loadData = async function () {

                /*
                    If input is data id => load ctrl.attrData from service and handle it independently
                    Else modify input ctrl.attrData
                */
                $rootScope.isBusy = true;
                var getDefault = await service.initData(ctrl.attrSetName);
                if (getDefault.isSucceed) {
                    ctrl.defaultData = getDefault.data;
                    ctrl.defaultData.data.user_name = ctrl.user.connection.name;
                    ctrl.defaultData.data.user_id = ctrl.user.connection.id;
                    ctrl.defaultData.data.user_avatar = ctrl.user.connection.avatar;
                    ctrl.defaultData.data.data_type = 9;
                    ctrl.defaultData.field = {
                        dataType: 9,
                        title: 'Message',
                        name: 'message'
                    };
                    ctrl.attrData = angular.copy(ctrl.defaultData);
                    $rootScope.isBusy = false;
                }
                var getFields = await fieldService.initData(ctrl.attrSetName);
                if (getFields.isSucceed) {
                    ctrl.fields = getFields.data;
                    ctrl.msgField = $rootScope.findObjectByKey(ctrl.fields, 'name', 'message');
                }
            };
            ctrl.submit = async function () {
                if (ctrl.validate()) {
                    ctrl.request.action = "send_group_message";
                    ctrl.request.uid = ctrl.user.connection.id;
                    ctrl.request.data = ctrl.attrData.data;
                    ctrl.request.connection = ctrl.user.connection;
                    ctrl.connection.invoke('HandleRequest', JSON.stringify(ctrl.request));
                    ctrl.attrData = angular.copy(ctrl.defaultData);
                }
            };
            ctrl.validate = function () {
                var isValid = true;
                ctrl.errors = [];
                angular.forEach(ctrl.fields, function (field) {
                    if (field.regex) {
                        var regex = RegExp(field.regex, 'g');
                        isValid = regex.test(ctrl.attrData.data[field.name]);
                        if(!isValid){
                            if(field.name=='message')
                            {
                                ctrl.errors.push('Please don\'t use bad words in your message');
                            }
                            else{
                                ctrl.errors.push(`${field.name} is not match Regex`);
                            }
                        }
                    }
                    if (isValid && field.isEncrypt) {
                        ctrl.attrData.data[field.name] = $rootScope.encrypt(ctrl.attrData.data[field.name]);
                    }

                });
                return isValid;
            };
            ctrl.receiveMessage = function (msg) {
                switch (msg.responseKey) {
                    case 'NewMember':
                        ctrl.newMember(msg.data);
                        // $('.widget-conversation').scrollTop = $('.widget-conversation')[0].scrollHeight;
                        break;
                    case 'NewMessage':
                        ctrl.newMessage(msg.data);
                        break;
                    case 'ConnectSuccess':
                        ctrl.user.loggedIn = true;
                        ctrl.initListMember(msg.data);
                        $scope.$apply();
                        break;
                    case 'PreviousMessages':
                        msg.data.items.forEach(element => {
                            element.msgField = angular.copy(ctrl.msgField);
                            element.msgField.dataType = element.data.data_type;
                        });
                        ctrl.messages = msg.data;
                        $scope.$apply();
                        break;
                    case 'MemberOffline':
                        ctrl.removeMember(msg.data);
                        break;
                    case 'Error':
                        console.error(msg.data);
                        break;

                }

            };
            ctrl.newMessage = function (msg) {
                msg.msgField = angular.copy(ctrl.msgField);
                ctrl.messages.items.push(msg);
                $scope.$apply();
            };
            ctrl.newMember = function (member) {
                var m = $rootScope.findObjectByKey(ctrl.members, 'id', member.id);
                if (!m) {
                    ctrl.members.push(member);
                }
                $scope.$apply();
            };
            ctrl.join = async function () {
                ctrl.request.action = "join_group";
                ctrl.request.uid = ctrl.user.connection.id;
                ctrl.request.data = ctrl.user.connection;
                ctrl.message.connection = ctrl.user.connection;
                ctrl.connection.invoke('HandleRequest', JSON.stringify(ctrl.request));
                await ctrl.loadData();
                $scope.$apply();
            };
            ctrl.initListMember = function (data) {
                data.forEach(member => {
                    var index = ctrl.members.findIndex(x => x.id === member.id);
                    if (index < 0) {
                        ctrl.members.splice(0, 0, member);
                    }
                });

                $scope.$apply();
            };
            ctrl.updateDataType = function () {
                ctrl.attrData.data.data_type = ctrl.msgField.dataType;
            };
            ctrl.checkLoginStatus = function () {
                FB.getLoginStatus(function (response) {
                    if (response.status === 'connected') {
                        // The user is logged in and has authenticated your
                        // app, and response.authResponse supplies
                        // the user's ID, a valid access token, a signed
                        // request, and the time the access token 
                        // and signed request each expire.
                        FB.api('/me', function (response) {
                            ctrl.user.connection.name = response.name;
                            ctrl.user.connection.id = response.id;
                            ctrl.user.connection.connectionId = ctrl.connection.connectionId;
                            ctrl.user.connection.avatar = '//graph.facebook.com/' + response.id + '/picture?width=32&height=32';
                            ctrl.user.loggedIn = true;
                            ctrl.join();
                        });
                    } else if (response.status === 'authorization_expired') {
                        // The user has signed into your application with
                        // Facebook Login but must go through the login flow
                        // again to renew data authorization. You might remind
                        // the user they've used Facebook, or hide other options
                        // to avoid duplicate account creation, but you should
                        // collect a user gesture (e.g. click/touch) to launch the
                        // login dialog so popup blocking is not triggered.
                    } else if (response.status === 'not_authorized') {
                        // The user hasn't authorized your application.  They
                        // must click the Login button, or you must call FB.login
                        // in response to a user gesture, to launch a login dialog.
                    } else {
                        // The user isn't logged in to Facebook. You can launch a
                        // login dialog with a user gesture, but the user may have
                        // to log in to Facebook before authorizing your application.
                    }
                });
            };
            ctrl.logout = function () {
                FB.logout(function (response) {
                    // user is now logged out
                    ctrl.user.loggedIn = false;
                });
            };
            ctrl.login = function () {
                FB.login(function (response) {
                    if (response.authResponse) {
                        FB.api('/me', function (response) {
                            ctrl.user.connection.name = response.name;
                            ctrl.user.connection.id = response.id;
                            ctrl.user.connection.connectionId = ctrl.connection.connectionId;
                            ctrl.user.connection.avatar = '//graph.facebook.com/' + response.id + '/picture?width=32&height=32';
                            ctrl.user.loggedIn = true;
                            ctrl.join();
                            $scope.$apply();
                        });
                    } else {
                        console.log('User cancelled login or did not fully authorize.');
                    }
                });
            };
        }]
});
modules.component('serviceHubClient', {
    templateUrl: '/app/app-client/components/service-hub-client/view.html',
    bindings: {
        attrSetName: '=',
        isSave: '=?'
    },
    controller: ['$rootScope', '$scope', 'AttributeFieldClientRestService', 'AttributeSetDataRestService',
    function ($rootScope, $scope, fieldService, service) {
        var ctrl = this;
        BaseHub.call(this, ctrl);
        ctrl.settings = $rootScope.globalSettings;
        ctrl.user = {
            loggedIn: false,
            connection: {}
        };
        ctrl.attrData = null;
        ctrl.isHide = true;
        ctrl.hideContact = true;
        ctrl.fields = [];
        ctrl.members = [];
        ctrl.errors =[];
        ctrl.messages = {
            items: []
        };
        ctrl.message = { connection: {}, content: '' };
        ctrl.request = {
            uid: '',
            specificulture: '',
            action: '',
            objectType: null,
            data: {},
            room: '',
            isMyself: true,
            isSave: false
        };
        ctrl.init = function () {
            ctrl.attrSetId = ctrl.attrSetId || 0;
            ctrl.request.specificulture = service.lang;
            ctrl.request.room = ctrl.attrSetName;
            ctrl.request.isSave = ctrl.isSave == 'true' || false;
            ctrl.startConnection('serviceHub', ctrl.checkLoginStatus);
        };
        ctrl.loadData = async function () {

            /*
                If input is data id => load ctrl.attrData from service and handle it independently
                Else modify input ctrl.attrData
            */
            $rootScope.isBusy = true;
            var getDefault = await service.initData(ctrl.attrSetName);
            if (getDefault.isSucceed) {
                ctrl.defaultData = getDefault.data;
                ctrl.defaultData.data.user_name = ctrl.user.connection.name;
                ctrl.defaultData.data.user_id = ctrl.user.connection.id;
                ctrl.defaultData.data.user_avatar = ctrl.user.connection.avatar;
                ctrl.defaultData.data.data_type = 9;
                ctrl.attrData = angular.copy(ctrl.defaultData);
                $rootScope.isBusy = false;
            }
            var getFields = await fieldService.initData(ctrl.attrSetName);
            if (getFields.isSucceed) {
                ctrl.fields = getFields.data;
            }
        };
        ctrl.submit = async function () {
            if (ctrl.validate()) {
                ctrl.request.action = "send_group_message";
                ctrl.request.uid = ctrl.user.connection.id;
                ctrl.request.data = ctrl.attrData.data;
                ctrl.request.connection = ctrl.user.connection;
                ctrl.connection.invoke('HandleRequest', JSON.stringify(ctrl.request));
                ctrl.attrData = angular.copy(ctrl.defaultData);
            }
        };
        ctrl.validate = function () {
            var isValid = true;
            ctrl.errors = [];
            angular.forEach(ctrl.fields, function (field) {
                if (field.regex) {
                    var regex = RegExp(field.regex, 'g');
                    isValid = regex.test(ctrl.attrData.data[field.name]);
                    if(!isValid){
                        ctrl.errors.push(`${field.name} is not match Regex`);
                    }
                }
                if (isValid && field.isEncrypt) {
                    ctrl.attrData.data[field.name] = $rootScope.encrypt(ctrl.attrData.data[field.name]);
                }

            });
            return isValid;
        };
        ctrl.receiveMessage = function (msg) {
            switch (msg.responseKey) {
                case 'NewMember':
                    ctrl.newMember(msg.data);
                    // $('.widget-conversation').scrollTop = $('.widget-conversation')[0].scrollHeight;
                    break;
                case 'NewMessage':
                    ctrl.newMessage(msg.data);
                    break;
                case 'ConnectSuccess':
                    ctrl.user.loggedIn = true;
                    ctrl.initListMember(msg.data);
                    $scope.$apply();
                    break;
                case 'PreviousMessages':
                    ctrl.messages = msg.data;
                    $scope.$apply();
                    break;
                case 'MemberOffline':
                    ctrl.removeMember(msg.data);
                    break;
                case 'Error':
                    console.error(msg.data);
                    break;

            }

        };
        ctrl.newMessage = function (msg) {
            ctrl.messages.items.push(msg);
            $scope.$apply();
        };
        ctrl.newMember = function (member) {
            var m = $rootScope.findObjectByKey(ctrl.members, 'id', member.id);
            if (!m) {
                ctrl.members.push(member);
            }
            $scope.$apply();
        };
        ctrl.join = async function () {
            ctrl.request.action = "join_group";
            ctrl.request.uid = ctrl.user.connection.id;
            ctrl.request.data = ctrl.user.connection;
            ctrl.message.connection = ctrl.user.connection;
            ctrl.connection.invoke('HandleRequest', JSON.stringify(ctrl.request));
            await ctrl.loadData();
            $scope.$apply();
        };
        ctrl.initListMember = function (data) {
            data.forEach(member => {
                var index = ctrl.members.findIndex(x => x.id === member.id);
                if (index < 0) {
                    ctrl.members.splice(0, 0, member);
                }
            });

            $scope.$apply();
        };
        
        ctrl.checkLoginStatus = function () {
            FB.getLoginStatus(function (response) {
                if (response.status === 'connected') {
                    // The user is logged in and has authenticated your
                    // app, and response.authResponse supplies
                    // the user's ID, a valid access token, a signed
                    // request, and the time the access token 
                    // and signed request each expire.
                    FB.api('/me', function (response) {
                        ctrl.user.connection.name = response.name;
                        ctrl.user.connection.id = response.id;
                        ctrl.user.connection.connectionId = ctrl.connection.connectionId;
                        ctrl.user.connection.avatar = '//graph.facebook.com/' + response.id + '/picture?width=32&height=32';
                        ctrl.user.loggedIn = true;
                        ctrl.join();
                    });
                } else if (response.status === 'authorization_expired') {
                    // The user has signed into your application with
                    // Facebook Login but must go through the login flow
                    // again to renew data authorization. You might remind
                    // the user they've used Facebook, or hide other options
                    // to avoid duplicate account creation, but you should
                    // collect a user gesture (e.g. click/touch) to launch the
                    // login dialog so popup blocking is not triggered.
                } else if (response.status === 'not_authorized') {
                    // The user hasn't authorized your application.  They
                    // must click the Login button, or you must call FB.login
                    // in response to a user gesture, to launch a login dialog.
                } else {
                    // The user isn't logged in to Facebook. You can launch a
                    // login dialog with a user gesture, but the user may have
                    // to log in to Facebook before authorizing your application.
                }
            });
        };
        ctrl.logout = function () {
            FB.logout(function (response) {
                // user is now logged out
                ctrl.user.loggedIn = false;
            });
        };
        ctrl.login = function () {
            FB.login(function (response) {
                if (response.authResponse) {
                    FB.api('/me', function (response) {
                        ctrl.user.connection.name = response.name;
                        ctrl.user.connection.id = response.id;
                        ctrl.user.connection.connectionId = ctrl.connection.connectionId;
                        ctrl.user.connection.avatar = '//graph.facebook.com/' + response.id + '/picture?width=32&height=32';
                        ctrl.user.loggedIn = true;
                        ctrl.join();
                        $scope.$apply();
                    });
                } else {
                    console.log('User cancelled login or did not fully authorize.');
                }
            });
        };
    }]
});
modules.component('shoppingCart', {
    templateUrl: '/app/app-client/components/shopping-cart/view.html',
    controller: [
        '$rootScope','localStorageService', 'CommonService', 
        function ($rootScope, localStorageService, commonService) {
            var ctrl = this;
            ctrl.submitted = false;
            ctrl.isShow = false;
            
            ctrl.edm = 'Url: <a href="[url]">View Tour</a> <br/>Name: [name] <br/>'
                        + 'Phone: [phone]<br/>'
                        + 'Email: [email]<br/>'
                        + 'Quantity: [quantity]<br/>'
                        + 'Message: [message] <br/>'
                        + 'property: [property] <br/>Price: [price] <br/>';
            ctrl.init = function () {
                
            };
            ctrl.showShoppingCart = function(){
                $('#modal-shopping-cart').modal('show');
            }
            ctrl.calculate = function(){
                ctrl.cartData.total = 0;
                ctrl.cartData.totalItems = ctrl.cartData.items.length;
                angular.forEach(ctrl.cartData.items, function(e){
                    ctrl.cartData.total+= (parseInt(e.price) * e.quantity);
                });
                localStorageService.set('shoppingCart', ctrl.cartData);
            };
            ctrl.removeItem = function(index){
                ctrl.cartData.items.splice(index,1);
                ctrl.calculate();
            }
            ctrl.book = function(){
                ctrl.edm = ctrl.edm.replace(/\[url\]/g,window.top.location.href);
                ctrl.edm = ctrl.edm.replace(/\[name\]/g,ctrl.order.name);
                ctrl.edm = ctrl.edm.replace(/\[phone\]/g,ctrl.order.phone);
                ctrl.edm = ctrl.edm.replace(/\[email\]/g,ctrl.order.email);
                ctrl.edm = ctrl.edm.replace(/\[message\]/g,ctrl.order.message);
                ctrl.edm = ctrl.edm.replace(/\[property\]/g,ctrl.order.propertyId);
                ctrl.edm = ctrl.edm.replace(/\[price\]/g,ctrl.order.price);
                ctrl.edm = ctrl.edm.replace(/\[quantity\]/g,ctrl.order.quantity);
                
                commonService.sendMail('Booking - ' + ctrl.propertyName, ctrl.edm);
                ctrl.submitted = true;
                setTimeout(() => {
                    ctrl.submitted = false;
                }, 1000);
                ctrl.cartData = {
                    items: [],
                    totalItems:0,
                    total:0,
                };
                localStorageService.set('shoppingCart', ctrl.cartData);
            }
        }
    ],
    bindings: {
        cartData: '='
    }
});

modules.component('haiyenLoader', {
    templateUrl: '/app/app-client/components/customs/loader/view.html',
    controller: ['$scope', '$location', function($scope, $location) {
        var ctrl = this;
        ctrl.imageDataArray = [];
        ctrl.canvasCount = 10;
        ctrl.duration = 500;
        ctrl.bgDuration = 2500;
        ctrl.canvas = null;
        ctrl.isLoaded = false;
        ctrl.init = function(){
                setTimeout(() => {                    
                    $scope.$apply(ctrl.isLoaded = true); 
                }, (500));
        };
        
    }],

    bindings: {
    }
});